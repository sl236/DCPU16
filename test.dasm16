def storedstate_a	8
def storedstate_b	7
def storedstate_c	6
def storedstate_x	5
def storedstate_y	4
def storedstate_z	3
def storedstate_i	2
def storedstate_j	1
def storedstate_ex	0

	set a, 1
	set b, 2
	set c, 3
	set x, 4
	set y, 5
	set z, 6
	set i, 7
	set j, 8
	set ex, 9
	jsr proc_storestate
	set a, 0xffff
	set b, 0xffff
	set c, 0xffff
	set x, 0xffff
	set y, 0xffff
	set z, 0xffff
	set i, 0xffff
	set j, 0xffff
	set ex, 0xffff
	jsr proc_restorestate
	sub pc, 1


; stores all regs and EX to stack
proc_storestate:
	xor [sp], a		; swap return address and a
	xor a, [sp]
	xor [sp], a
	set push, b
	set push, c
	set push, x
	set push, y
	set push, z
	set push, i
	set push, j
	set push, ex
	set push, a						; store return address
	set a, [sp+storedstate_a+1]		; restore correct a value
	set pc, pop		

; restores all regs and EX from stack content created by proc_storestate
proc_restorestate:
	set a, pop		; return addr
	set ex, pop		; restore other regs
	set j, pop
	set i, pop
	set z, pop
	set y, pop
	set x, pop
	set c, pop
	set b, pop
	xor [sp], a		; swap return addr and a
	xor a, [sp]
	xor [sp], a
	set pc, pop